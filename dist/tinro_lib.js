import{getContext as Y}from"svelte";import{writable as q}from"svelte/store";function d(t,r=!1){return t=t.slice(t.startsWith("/#")?2:0,t.endsWith("/*")?-2:void 0),t.startsWith("/")||(t="/"+t),t==="/"&&(t=""),r&&!t.endsWith("/")&&(t+="/"),t}function g(t,r){t=d(t,!0),r=d(r,!0);let a=[],n={},e=!0,o=t.split("/").map(c=>c.startsWith(":")?(a.push(c.slice(1)),"([^\\/]+)"):c).join("\\/"),i=r.match(new RegExp(`^${o}$`));return i||(e=!1,i=r.match(new RegExp(`^${o}`))),i?(a.forEach((c,x)=>n[c]=i[x+1]),{exact:e,params:n,part:i[0].slice(0,-1)}):null}function k(t,r,a){if(a==="")return t;if(a[0]==="/")return a;let n=i=>i.split("/").filter(c=>c!==""),e=n(t),o=r?n(r):[];return"/"+o.map((i,c)=>e[c]).join("/")+"/"+a}function h(t,r,a,n){let e=[r,"data-"+r].reduce((o,i)=>{let c=t.getAttribute(i);return a&&t.removeAttribute(i),c===null?o:c},!1);return!n&&e===""?!0:e||n||!1}function S(t){let r=t.split("&").map(a=>a.split("=")).reduce((a,n)=>{let e=n[0];if(!e)return a;let o=n.length>1?n[n.length-1]:!0;return typeof o=="string"&&o.includes(",")&&(o=o.split(",")),a[e]===void 0?a[e]=[o]:a[e].push(o),a},{});return Object.entries(r).reduce((a,n)=>(a[n[0]]=n[1].length>1?n[1]:n[1][0],a),{})}function y(t){throw new Error("[Tinro] "+t)}var R=1,O=2,_=3,C=4;function H(t,r,a,n){return t===R?r&&r():t===O?a&&a():n&&n()}function j(){return!window||window.location.pathname==="srcdoc"?_:R}var l={HISTORY:R,HASH:O,MEMORY:_,OFF:C,run:H,getDeafault:j};var M,b,s=z();function z(){let t=l.getDeafault(),r,a=o=>window.onhashchange=window.onpopstate=b=null,n=o=>r&&r(E(t));function e(o){o&&(t=o),a(),t!==l.OFF&&l.run(t,i=>window.onpopstate=n,i=>window.onhashchange=n)&&n()}return{mode:o=>e(o),get:o=>E(t),go(o){console.log("go(href)"),F(t,o),n()},replace(o){console.log("going to replace 3"),D(t,o),n()},start(o){r=o,e()},stop(){r=null,e(l.OFF)}}}function D(t,r){console.log("Replacing location"),l.run(t,a=>history.replaceState({},"",r),a=>window.location.hash=r,a=>b=r)}function F(t,r){console.log("SET LOCATION (new)"),l.run(t,a=>history.pushState({},"",r),a=>window.location.hash=r,a=>b=r)}function E(t){let r=M,a=M=l.run(t,e=>window.location.pathname+window.location.search,e=>String(window.location.hash.slice(1)||"/"),e=>b||"/"),n=a.match(/^([^?#]+)(?:\?([^#]+))?(?:\#(.+))?$/);return{url:a,from:r,path:n[1]||"",query:S(n[2]||""),hash:n[3]||""}}import{getContext as L,setContext as P,onMount as T,tick as A}from"svelte";import{writable as U}from"svelte/store";function W(t){let r=L("tinro");r&&(r.exact||r.fallback)&&y(`${t.fallback?"<Route fallback>":`<Route path="${t.path}">`}  can't be inside ${r.fallback?"<Route fallback>":`<Route path="${r.path||"/"}"> with exact path`}`);let a=t.fallback?"fallbacks":"childs",n=U({}),e={router:{},exact:!1,pattern:null,meta:{},parent:r,fallback:t.fallback,redirect:!1,replace:!1,firstmatch:!1,breadcrumb:null,matched:!1,childs:new Set,activeChilds:new Set,fallbacks:new Set,update(o){e.exact=!o.path.endsWith("/*"),e.pattern=d(`${e.parent&&e.parent.pattern||""}${o.path}`),e.redirect=o.redirect,e.replace=o.replace,e.firstmatch=o.firstmatch,e.breadcrumb=o.breadcrumb,e.match()},register:()=>{if(!!e.parent)return e.parent[a].add(e),()=>{e.parent[a].delete(e),e.router.un&&e.router.un()}},show:()=>{t.onShow(),!e.fallback&&e.parent&&e.parent.activeChilds.add(e)},hide:()=>{t.onHide(),!e.fallback&&e.parent&&e.parent.activeChilds.delete(e)},match:async()=>{e.matched=!1;let{path:o,url:i,from:c,query:x}=e.router,u=g(e.pattern,o);if(console.log("route",e),!e.fallback&&u&&(e.redirect||e.replace)&&(!e.exact||e.exact&&u.exact)){await A();let m=k(o,e.parent&&e.parent.pattern,e.redirect);return e.redirect?(console.log("going going gone"),f.goto(m)):(console.log("in here redirect 1"),f.replaceWith(m))}if(e.meta=u&&{from:c,url:i,query:x,match:u.part,pattern:e.pattern,breadcrumbs:e.parent&&e.parent.meta&&e.parent.meta.breadcrumbs.slice()||[],params:u.params,subscribe:n.subscribe},e.breadcrumb&&e.meta&&e.meta.breadcrumbs.push({name:e.breadcrumb,path:u.part}),n.set(e.meta),u&&!e.fallback&&(!e.exact||e.exact&&u.exact)&&(!e.parent||!e.parent.firstmatch||!e.parent.matched)?(t.onMeta(e.meta),e.parent&&(e.parent.matched=!0),e.show()):e.hide(),await A(),u&&!e.fallback&&(e.childs.size>0&&e.activeChilds.size==0||e.childs.size==0&&e.fallbacks.size>0)){let m=e;for(;m.fallbacks.size==0;)if(m=m.parent,!m)return;m&&m.fallbacks.forEach(p=>{if(p.redirect||p.replace){let v=k("/",p.parent&&p.parent.pattern,p.redirect);p.redirect?(console.log("in here redirect 2"),console.log("going going gone"),f.goto(v)):(console.log("in here replace 2"),f.replaceWith(v))}else p.show()})}}};return P("tinro",e),T(()=>e.register()),e.router.un=f.subscribe(o=>{e.router.path=o.path,e.router.url=o.url,e.router.query=o.query,e.router.from=o.from,e.pattern!==null&&e.match()}),e}function w(){return L("tinro").meta}var f=I();function I(){let{subscribe:t}=q(s.get(),r=>{s.start(r),console.log("setting up some listener");let a=K(s.go);return()=>{s.stop(),a()}});return{subscribe:t,goto:r=>s.go(r),replaceWith:r=>s.replace(r),params:N,meta:w,useHashNavigation:r=>s.mode(r?l.HASH:l.HISTORY),mode:{hash:()=>s.mode(l.HASH),history:()=>s.mode(l.HISTORY),memory:()=>s.mode(l.MEMORY)}}}function $(t){let r=h(t,"href"),a=h(t,"exact",!0),n=h(t,"active-class",!0,"active");return{destroy:f.subscribe(e=>{let o=g(r,e.path);o&&(o.exact&&a||!a)?t.classList.add(n):t.classList.remove(n)})}}function K(t){let r=a=>{let n=a.target.closest("a[href]"),e=n&&h(n,"target",!1,"_self"),o=n&&h(n,"tinro-ignore"),i=a.ctrlKey||a.metaKey||a.altKey||a.shiftKey;if(e=="_self"&&!o&&!i&&n){let c=n.getAttribute("href").replace(/^\/#/,"");/^\/\/|^[a-zA-Z]+:/.test(c)||(a.preventDefault(),t(c.startsWith("/")?c:n.href.replace(window.location.origin,"")))}};return addEventListener("click",r),()=>removeEventListener("click",r)}function N(){return Y("tinro").meta.params}export{$ as active,W as createRouteObject,w as meta,f as router};
